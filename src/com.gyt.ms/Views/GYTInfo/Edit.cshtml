@using Zer.Entities
@using Zer.GytDto

@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";


    var provinceList = ViewBag.ProvinceList as List<string>;
    var characterList = ViewBag.CharacterList as List<string>;

    var gytInfoDto = Model as GYTInfoDto;
}

<h3 class="header smaller lighter blue">港运通信息编辑</h3>

@if (gytInfoDto != null)
{
    <div class="form-horizontal">
        <input value="@gytInfoDto.Id" class="hide" name="Id" id="__Id" />
        <input value="@gytInfoDto.BusinessType" class="hide" name="BusinessType" id="BusinessType" />
        

        <div class="form-group">
            <label class="col-sm-4 control-label no-padding-right" for="input_bidCompnyName" style="color: red"> 申办企业 </label>

            <div class="col-sm-8">
                <input type="text" id="input_bidCompnyName" placeholder="申办企业名称" class="col-xs-10 col-sm-5" value="@gytInfoDto.BidCompanyName" name="BidCompanyName">
                <label id="lbl_userName" style="color: red; display: none"></label>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-4 control-label no-padding-right" for="input_bidTruckNo"> 申办车牌号: </label>
            <div class="col-sm-8">
                <select class="select2-default _bidTruckNo_province col-sm-1">
                    <option></option>
                    @{
                        if (provinceList != null && provinceList.Count > 0)
                        {
                            foreach (var item in provinceList)
                            {
                                if (gytInfoDto.BidTruckNo.Substring(0, 1).Equals(item))
                                {
                        <option value="@item" selected="selected">@item</option>
                                }
                                else
                                {
                        <option value="@item">@item</option>
                                }
                            }
                        }
                    }
                </select>

                <select class="select2-default _bidTruckNo_character col-sm-1" style="margin-left: 8px">
                    <option></option>
                    @{
                        if (characterList != null && characterList.Count > 0)
                        {
                            foreach (var item in characterList)
                            {
                                if (gytInfoDto.BidTruckNo.Substring(1, 1).Equals(item))
                                {
                        <option value="@item" selected="selected">@item</option>
                                }
                                else
                                {
                        <option value="@item">@item</option>
                                }
                            }
                        }
                    }
                </select>
                <input type="text" placeholder="请输入申办车牌号" id="input_bidTruckNo" class="4" style="margin-left: 8px" value="@gytInfoDto.BidTruckNo.Substring(2)">
                <label id="lbl_bidTruckNo" style="color: red; display: none"></label>
                <input type="text" class="hide" name="BidTruckNo">
            </div>
        </div>

        @if (gytInfoDto.BusinessType != BusinessType.天然气车辆)
        {
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-4 control-label no-padding-right" for="input_bidTruckNo"> 原企业名称 </label>

            <div class="col-sm-8">
                <input type="text" id="input_OriginalCompanyName" placeholder="原企业名称" class="col-xs-10 col-sm-5" value="@gytInfoDto.OriginalCompanyName" name="OriginalCompanyName">
                <label id="lbl_OriginalCompanyName" style="color: red; display: none"></label>
            </div>
        </div>

        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-4 control-label no-padding-right" for="input_bidTruckNo" style="color: red"> 原车牌号 </label>

            <div class="col-sm-8">
                <select class="select2-default _OriginalTruckNo_province col-sm-1">
                    <option></option>
                    @{
                        if (provinceList != null && provinceList.Count > 0)
                        {
                            foreach (var item in provinceList)
                            {
                                if (gytInfoDto.BidTruckNo.Substring(0, 1).Equals(item))
                                {
                        <option value="@item" selected="selected">@item</option>
                                }
                                else
                                {
                        <option value="@item">@item</option>
                                }
                            }
                        }
                    }
                </select>

                <select class="select2-default _OriginalTruckNo_character col-sm-1" style="margin-left: 8px">
                    <option></option>
                    @{
                        if (characterList != null && characterList.Count > 0)
                        {
                            foreach (var item in characterList)
                            {
                                if (gytInfoDto.BidTruckNo.Substring(1, 1).Equals(item))
                                {
                        <option value="@item" selected="selected">@item</option>
                                }
                                else
                                {
                        <option value="@item">@item</option>
                                }
                            }
                        }
                    }
                </select>
                <input type="text" id="input_originalTruckNo" placeholder="原车牌号"  style="margin-left: 8px" value="@gytInfoDto.OriginalTruckNo.Substring(2)">
                <label id="lbl_originalTruckNo" style="color: red; display: none"></label>
                <input type="text" class="hide" name="OriginalTruckNo">
            </div>
        </div>
        }
        
        <div class="form-group">
            <label class="col-sm-4 control-label no-padding-right" for="input_bidTruckNo" style="color: red"> 业务状态 </label>

            <div class="col-sm-8">
                <select class="select2-default __Status col-sm-2" name="Status" id="Status">
                    <option value="@BusinessState.已办理" @(gytInfoDto.Status == BusinessState.已办理?"selected":"")>已办理</option>
                    <option value="@BusinessState.已注销" @(gytInfoDto.Status == BusinessState.已注销?"selected":"")>已注销</option>
                </select>
            </div>
        </div>
    
        <div class="space-4"></div>

        <div class="clearfix form-actions">
            <div class="col-md-offset-3 col-md-9">
                <a href="javascript:;" class="btn btn-info" id="btn_Save">
                    <i class="icon-ok bigger-110"></i>
                    保存
                </a>

                &nbsp; &nbsp; &nbsp;
                <label class="btn __btn_cancel">
                    <i class="icon-undo bigger-110"></i>
                    取消
                </label>
            </div>
        </div>
    </div>
}

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header alert-success">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title __dialog_title" id="myModalLabel">
                    港运通记录修改结果
                </h4>
            </div>
            <div class="modal-body __dialog_content">
               
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info __modal_confirmed">
                    确认
                </button>
                <button type="button" class="btn btn-success __modal_close" data-dismiss="modal">
                    返回
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

@section scripts
{
    <script type="text/javascript">
        $(function() {

        $("body")
            .on('click', '.__btn_cancel',function() {
                window.location = '@Url.Action("Index","GYTInfo")';
            })
            .on('blur', '#input_originalTruckNo', function () {
                var truckNo = $('#input_originalTruckNo').val();

                if (truckNo.length !== 5) {
                    $('#lbl_originalTruckNo').html("原车牌号长度不正确");
                } else {
                    $('#lbl_originalTruckNo').html("");
                }
            })
            .on('blur', '#input_bidTruckNo', function () {
                var truckNo = $('#input_bidTruckNo').val();

                if (truckNo.length !== 5) {
                    $('#lbl_bidTruckNo').html("申办车牌号长度不正确");
                } else {
                    $('#lbl_bidTruckNo').html("");
                }
            })

            .on('click', '.__modal_close', function () {
                $('#myModal').modal("hide");
            })
            // 确认按钮
            .on('click', '.__modal_confirmed', function () {
                window.location = '@Url.Action("index","GYTInfo")';
            })

            .on("click","#btn_Save",function() {
                var originalTruckNo = $("._OriginalTruckNo_province").val() + $("._OriginalTruckNo_character").val() + $("#input_originalTruckNo").val();
                $("input[name^='OriginalTruckNo']").val(originalTruckNo);

                var bidTruckNo = $("._bidTruckNo_province").val() + $("._bidTruckNo_character").val() + $("#input_bidTruckNo").val();
                $("input[name^='BidTruckNo']").val(bidTruckNo);

                var id = $('#__Id').val();
                var businessType = $('#BusinessType').val();
                var input_bidCompnyName = $('#input_bidCompnyName').val();
                var input_OriginalCompanyName = $('#input_OriginalCompanyName').val();

                var postData = {
                    Id: id,
                    BusinessType: businessType,
                    OriginalCompanyName:input_OriginalCompanyName,
                    OriginalTruckNo: originalTruckNo,
                    BidCompanyName: input_bidCompnyName,
                    BidTruckNo: bidTruckNo
                };

                $.ajax({
                    url: '@Url.Action("SaveEdit","GYTInfo")',
                    type: 'post',
                    data: postData,
                    success: function(d) {
                        console.log(d);


                        // 办理成功
                        if (d.C === 901) {
                            $('.modal-header').removeClass('alert-danger');
                            $('.modal-header').addClass('alert-success');
                            $('.__dialog_content')
                                .html('<h5>修改成功</h5><span>与原车牌号:<i class="label label-sm label-danger">' +
                                    OriginalTruckNo +
                                    '</i>绑定的港运通已经注销</span>');

                            // 设置【确认】按钮显示
                            $('.__modal_confirmed').show();
                            $('#myModal').modal("show");
                        }
                        // 办理失败
                        else {
                            $('.modal-header').removeClass('alert-success');
                            $('.modal-header').addClass('alert-danger');

                            var msg = "<label class='label label-lg label-danger'>修改失败</label><ul>";
                            for (var i = 0; i < d.data.length; i++) {
                                msg += '<li><span><i class="">' +
                                    d.data[i] +
                                    '</i></span></li>';
                            }

                            msg += "</ul>";
                            $('.__dialog_content').html(msg);
                            // 设置【确认】按钮隐藏
                            $('.__modal_confirmed').hide();
                            $('#myModal').modal("show");
                        }
                    }
                });
            });
        })
    </script>
}
